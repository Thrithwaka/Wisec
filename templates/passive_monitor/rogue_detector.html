<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WISEC - Rogue AP Detection</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 35%, #2c1810 100%);
            color: #e8e8e8;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 0 10px;
        }

        .header h1 {
            color: #ccd6f6;
            font-size: 32px;
            font-weight: 300;
        }

        .header .subtitle {
            color: #8892b0;
            font-size: 16px;
            margin-top: 5px;
        }

        .back-link {
            color: #64ffda;
            text-decoration: none;
            display: flex;
            align-items: center;
            font-size: 14px;
            transition: color 0.3s ease;
        }

        .back-link:hover {
            color: #f85149;
        }

        .back-link i {
            margin-right: 8px;
        }

        .card {
            background: rgba(15, 20, 25, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(100, 255, 218, 0.1);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: rgba(100, 255, 218, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid rgba(100, 255, 218, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            display: flex;
            align-items: center;
            color: #ccd6f6;
            font-size: 18px;
            font-weight: 500;
        }

        .card-icon {
            margin-right: 12px;
            color: #64ffda;
        }

        .card-content {
            padding: 20px;
        }

        .threat-level-indicator {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .threat-low {
            background: rgba(46, 160, 67, 0.2);
            color: #2ea043;
            border: 1px solid rgba(46, 160, 67, 0.3);
        }

        .threat-medium {
            background: rgba(251, 133, 0, 0.2);
            color: #fb8500;
            border: 1px solid rgba(251, 133, 0, 0.3);
        }

        .threat-high {
            background: rgba(248, 81, 73, 0.2);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.3);
        }

        .threat-critical {
            background: rgba(139, 0, 0, 0.3);
            color: #ff4444;
            border: 1px solid rgba(139, 0, 0, 0.5);
            animation: pulse-critical 2s infinite;
        }

        @keyframes pulse-critical {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(26, 31, 46, 0.5);
            border: 1px solid rgba(100, 255, 218, 0.1);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: rgba(100, 255, 218, 0.3);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #8892b0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-critical { color: #f85149; }
        .stat-high { color: #fb8500; }
        .stat-medium { color: #64ffda; }
        .stat-low { color: #2ea043; }

        .btn {
            display: inline-flex;
            align-items: center;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        .btn i {
            margin-right: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f85149 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(248, 81, 73, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(248, 81, 73, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: rgba(100, 255, 218, 0.1);
            color: #64ffda;
            border: 1px solid rgba(100, 255, 218, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(100, 255, 218, 0.2);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: rgba(248, 81, 73, 0.2);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.3);
        }

        .btn-danger:hover {
            background: rgba(248, 81, 73, 0.3);
            transform: translateY(-2px);
        }

        .detection-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .detection-table th,
        .detection-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(100, 255, 218, 0.1);
        }

        .detection-table th {
            background: rgba(26, 31, 46, 0.5);
            color: #ccd6f6;
            font-weight: 600;
        }

        .detection-table td {
            color: #8892b0;
        }

        .threat-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .threat-badge-critical {
            background: rgba(139, 0, 0, 0.3);
            color: #ff4444;
        }

        .threat-badge-high {
            background: rgba(248, 81, 73, 0.2);
            color: #f85149;
        }

        .threat-badge-medium {
            background: rgba(251, 133, 0, 0.2);
            color: #fb8500;
        }

        .threat-badge-low {
            background: rgba(46, 160, 67, 0.2);
            color: #2ea043;
        }

        .rogue-details {
            background: rgba(26, 31, 46, 0.3);
            border-left: 3px solid #f85149;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }

        .evil-twin-details {
            background: rgba(139, 0, 0, 0.2);
            border-left: 3px solid #ff4444;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }

        .suspicious-details {
            background: rgba(251, 133, 0, 0.1);
            border-left: 3px solid #fb8500;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }

        .risk-factors {
            margin-top: 10px;
        }

        .risk-factor {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 13px;
            color: #8892b0;
        }

        .risk-factor i {
            margin-right: 8px;
            color: #f85149;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid rgba(100, 255, 218, 0.1);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            color: #8892b0;
        }

        .tab.active {
            color: #64ffda;
            border-bottom-color: #64ffda;
        }

        .tab:hover {
            color: #ccd6f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .alert i {
            margin-right: 12px;
            font-size: 18px;
        }

        .alert-info {
            background: rgba(83, 62, 232, 0.1);
            color: #533ee8;
            border: 1px solid rgba(83, 62, 232, 0.2);
        }

        .alert-warning {
            background: rgba(251, 133, 0, 0.1);
            color: #fb8500;
            border: 1px solid rgba(251, 133, 0, 0.2);
        }

        .alert-danger {
            background: rgba(248, 81, 73, 0.1);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.2);
        }

        .alert-success {
            background: rgba(46, 160, 67, 0.1);
            color: #2ea043;
            border: 1px solid rgba(46, 160, 67, 0.2);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(26, 31, 46, 0.5);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f85149, #dc2626);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .hidden {
            display: none;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-active {
            background: rgba(248, 81, 73, 0.2);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.3);
        }

        .status-inactive {
            background: rgba(136, 146, 176, 0.2);
            color: #8892b0;
            border: 1px solid rgba(136, 146, 176, 0.3);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #ccd6f6;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            background: rgba(26, 31, 46, 0.7);
            border: 1px solid rgba(100, 255, 218, 0.2);
            border-radius: 8px;
            color: #e8e8e8;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #64ffda;
            box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.1);
        }

        .recommendations {
            background: rgba(83, 62, 232, 0.1);
            border-left: 4px solid #533ee8;
            padding: 20px;
            border-radius: 0 8px 8px 0;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            margin: 10px 0;
            color: #ccd6f6;
        }

        .recommendation-item i {
            margin-right: 12px;
            margin-top: 2px;
            color: #533ee8;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .detection-table {
                font-size: 12px;
            }

            .tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>🚨 Rogue AP Detection</h1>
                <div class="subtitle">Advanced Evil Twin & Rogue Access Point Detection</div>
            </div>
            <a href="/passive-monitor" class="back-link">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </a>
        </div>

        <!-- Detection Control Panel -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-shield-alt card-icon"></i>
                    Detection Control Panel
                </h3>
                <div class="status-indicator status-inactive" id="detectionStatus">
                    <i class="fas fa-circle"></i>
                    <span>Inactive</span>
                </div>
            </div>
            <div class="card-content">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Detection Mode</label>
                        <select class="form-control" id="detectionMode">
                            <option value="comprehensive">Comprehensive Scan (Recommended)</option>
                            <option value="evil_twin">Evil Twin Detection Only</option>
                            <option value="rogue_ap">Rogue AP Detection Only</option>
                            <option value="suspicious">Suspicious Behavior Only</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Scan Duration (seconds)</label>
                        <input type="number" class="form-control" id="scanDuration" value="120" min="60" max="600">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Sensitivity Level</label>
                        <select class="form-control" id="sensitivityLevel">
                            <option value="high">High (More False Positives)</option>
                            <option value="medium" selected>Medium (Balanced)</option>
                            <option value="low">Low (Fewer False Positives)</option>
                        </select>
                    </div>
                </div>

                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>Rogue AP Detection:</strong> This system analyzes nearby WiFi networks for signs of rogue access points, 
                        evil twin attacks, and suspicious behavior patterns. High sensitivity may produce false positives in dense WiFi environments.
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="startRogueDetection()" id="startBtn">
                        <i class="fas fa-play"></i>
                        Start Detection
                    </button>
                    <button class="btn btn-danger hidden" onclick="stopRogueDetection()" id="stopBtn">
                        <i class="fas fa-stop"></i>
                        Stop Detection
                    </button>
                    <button class="btn btn-secondary" onclick="exportResults()" id="exportBtn" disabled>
                        <i class="fas fa-download"></i>
                        Export Results
                    </button>
                    <button class="btn btn-secondary" onclick="clearResults()" id="clearBtn">
                        <i class="fas fa-trash"></i>
                        Clear Results
                    </button>
                </div>

                <div class="progress-bar hidden" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>

        <!-- Threat Level Overview -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-exclamation-triangle card-icon"></i>
                    Threat Level Assessment
                </h3>
                <div class="threat-level-indicator threat-low" id="threatLevel">
                    <i class="fas fa-shield-alt"></i>
                    <span>Low Risk</span>
                </div>
            </div>
            <div class="card-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value stat-critical" id="evilTwinsCount">0</div>
                        <div class="stat-label">Evil Twins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-high" id="rogueApsCount">0</div>
                        <div class="stat-label">Rogue APs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-medium" id="suspiciousCount">0</div>
                        <div class="stat-label">Suspicious</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-low" id="legitimateCount">0</div>
                        <div class="stat-label">Legitimate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-medium" id="openNetworksCount">0</div>
                        <div class="stat-label">Open Networks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-high" id="weakSecurityCount">0</div>
                        <div class="stat-label">Weak Security</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="threatDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Detection Results -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-search card-icon"></i>
                    Detection Results
                </h3>
            </div>
            <div class="card-content">
                <div class="tabs">
                    <div class="tab active" onclick="showTab('evilTwins')">
                        <i class="fas fa-clone"></i> Evil Twins
                    </div>
                    <div class="tab" onclick="showTab('rogueAps')">
                        <i class="fas fa-wifi"></i> Rogue APs
                    </div>
                    <div class="tab" onclick="showTab('suspicious')">
                        <i class="fas fa-question-circle"></i> Suspicious
                    </div>
                    <div class="tab" onclick="showTab('recommendations')">
                        <i class="fas fa-lightbulb"></i> Recommendations
                    </div>
                </div>

                <!-- Evil Twins Tab -->
                <div id="evilTwinsTab" class="tab-content active">
                    <div id="evilTwinsContainer">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <div>No evil twin networks detected. Start detection to analyze your environment.</div>
                        </div>
                    </div>
                </div>

                <!-- Rogue APs Tab -->
                <div id="rogueApsTab" class="tab-content">
                    <div id="rogueApsContainer">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <div>No rogue access points detected. Start detection to analyze your environment.</div>
                        </div>
                    </div>
                </div>

                <!-- Suspicious Tab -->
                <div id="suspiciousTab" class="tab-content">
                    <div id="suspiciousContainer">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <div>No suspicious network activity detected. Start detection to analyze your environment.</div>
                        </div>
                    </div>
                </div>

                <!-- Recommendations Tab -->
                <div id="recommendationsTab" class="tab-content">
                    <div id="recommendationsContainer">
                        <div class="recommendations">
                            <h4 style="color: #533ee8; margin-bottom: 15px;">
                                <i class="fas fa-lightbulb"></i>
                                Security Recommendations
                            </h4>
                            <div class="recommendation-item">
                                <i class="fas fa-info-circle"></i>
                                <div>Start rogue AP detection to receive personalized security recommendations based on your environment.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let detecting = false;
        let detectionStartTime = null;
        let detectionInterval = null;
        let progressInterval = null;
        let threatChart = null;
        let detectionResults = {
            evil_twins: [],
            rogue_aps: [],
            suspicious: [],
            recommendations: []
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Rogue AP Detection page initializing...');
            initializeThreatChart();
            loadInitialData();
            checkDetectionStatus();
        });

        // Initialize threat distribution chart
        function initializeThreatChart() {
            const ctx = document.getElementById('threatDistributionChart').getContext('2d');
            threatChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Evil Twins', 'Rogue APs', 'Suspicious', 'Legitimate'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(139, 0, 0, 0.8)',    // Critical - Dark Red
                            'rgba(248, 81, 73, 0.8)',  // High - Red
                            'rgba(251, 133, 0, 0.8)',  // Medium - Orange
                            'rgba(46, 160, 67, 0.8)'   // Low - Green
                        ],
                        borderColor: [
                            '#8B0000',
                            '#f85149',
                            '#fb8500',
                            '#2ea043'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#8892b0'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Threat Distribution',
                            color: '#ccd6f6'
                        }
                    }
                }
            });
        }

        // Start rogue detection
        async function startRogueDetection() {
            try {
                const mode = document.getElementById('detectionMode').value;
                const duration = parseInt(document.getElementById('scanDuration').value);
                const sensitivity = document.getElementById('sensitivityLevel').value;

                showNotification('Starting rogue AP detection...', 'info');

                const response = await fetch('/passive-monitor/api/start-rogue-detection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        mode: mode,
                        duration: duration,
                        sensitivity: sensitivity
                    })
                });

                const result = await response.json();

                if (result.success) {
                    detecting = true;
                    detectionStartTime = new Date();
                    updateDetectionUI();
                    startRealTimeUpdates();
                    startProgressTracking(duration);
                    showNotification('Rogue AP detection started successfully', 'success');
                } else {
                    if (result.requires_approval) {
                        showNotification('Advanced features access required. Please contact admin for approval.', 'warning');
                        // Could redirect to approval page here
                        window.location.href = '/main/dashboard';
                    } else {
                        throw new Error(result.message || 'Failed to start detection');
                    }
                }

            } catch (error) {
                console.error('Error starting detection:', error);
                showNotification('Failed to start detection: ' + error.message, 'error');
            }
        }

        // Stop rogue detection
        async function stopRogueDetection() {
            try {
                showNotification('Stopping rogue AP detection...', 'info');

                const response = await fetch('/passive-monitor/api/stop-rogue-detection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    detecting = false;
                    updateDetectionUI();
                    stopRealTimeUpdates();
                    stopProgressTracking();
                    
                    // Load final results
                    await loadDetectionResults();
                    
                    showNotification('Rogue AP detection stopped', 'info');
                    document.getElementById('exportBtn').disabled = false;
                } else {
                    throw new Error(result.message || 'Failed to stop detection');
                }

            } catch (error) {
                console.error('Error stopping detection:', error);
                showNotification('Failed to stop detection: ' + error.message, 'error');
            }
        }

        // Update detection UI
        function updateDetectionUI() {
            const statusIndicator = document.getElementById('detectionStatus');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const progressBar = document.getElementById('progressBar');

            if (detecting) {
                statusIndicator.className = 'status-indicator status-active';
                statusIndicator.innerHTML = '<i class="fas fa-circle"></i><span>Detecting</span>';
                
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                progressBar.classList.remove('hidden');
            } else {
                statusIndicator.className = 'status-indicator status-inactive';
                statusIndicator.innerHTML = '<i class="fas fa-circle"></i><span>Inactive</span>';
                
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                progressBar.classList.add('hidden');
            }
        }

        // Start real-time updates
        function startRealTimeUpdates() {
            detectionInterval = setInterval(async () => {
                try {
                    const response = await fetch('/passive-monitor/api/rogue-detection-status', {
                        headers: { 'Accept': 'application/json' }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        updateRealtimeStats(data);
                        updateThreatChart(data);
                        
                        // Check if detection is still active
                        if (!data.is_detecting && detecting) {
                            detecting = false;
                            updateDetectionUI();
                            stopRealTimeUpdates();
                            await loadDetectionResults();
                        }
                    }
                } catch (error) {
                    console.error('Error fetching real-time data:', error);
                }
            }, 5000); // Update every 5 seconds
        }

        // Stop real-time updates
        function stopRealTimeUpdates() {
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
        }

        // Start progress tracking
        function startProgressTracking(duration) {
            const progressFill = document.getElementById('progressFill');
            let elapsed = 0;

            progressInterval = setInterval(() => {
                elapsed += 1;
                const progress = Math.min((elapsed / duration) * 100, 100);
                progressFill.style.width = progress + '%';

                if (elapsed >= duration) {
                    stopProgressTracking();
                }
            }, 1000);
        }

        // Stop progress tracking
        function stopProgressTracking() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        // Update real-time statistics
        function updateRealtimeStats(data) {
            document.getElementById('evilTwinsCount').textContent = data.evil_twins_detected || 0;
            document.getElementById('rogueApsCount').textContent = data.rogue_aps_detected || 0;
            document.getElementById('suspiciousCount').textContent = data.suspicious_networks || 0;
            document.getElementById('legitimateCount').textContent = data.legitimate_networks || 0;
            document.getElementById('openNetworksCount').textContent = data.open_networks || 0;
            document.getElementById('weakSecurityCount').textContent = data.weak_security_networks || 0;

            // Update threat level
            updateThreatLevel(data.threat_level || 'LOW');
        }

        // Update threat level indicator
        function updateThreatLevel(level) {
            const indicator = document.getElementById('threatLevel');
            const levelText = level.toUpperCase();
            
            indicator.className = `threat-level-indicator threat-${level.toLowerCase()}`;
            indicator.innerHTML = `<i class="fas fa-${getThreatIcon(level)}"></i><span>${levelText} Risk</span>`;
        }

        // Get threat level icon
        function getThreatIcon(level) {
            switch(level.toLowerCase()) {
                case 'critical': return 'exclamation-triangle';
                case 'high': return 'exclamation-circle';
                case 'medium': return 'info-circle';
                default: return 'shield-alt';
            }
        }

        // Update threat chart
        function updateThreatChart(data) {
            if (threatChart) {
                threatChart.data.datasets[0].data = [
                    data.evil_twins_detected || 0,
                    data.rogue_aps_detected || 0,
                    data.suspicious_networks || 0,
                    data.legitimate_networks || 0
                ];
                threatChart.update('none');
            }
        }

        // Load detection results
        async function loadDetectionResults() {
            try {
                const response = await fetch('/passive-monitor/api/rogue-detection-results', {
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    detectionResults = data;
                    
                    updateEvilTwinsDisplay(data.evil_twins_detected || []);
                    updateRogueApsDisplay(data.rogue_aps_detected || []);
                    updateSuspiciousDisplay(data.suspicious_networks || []);
                    updateRecommendationsDisplay(data.security_recommendations || []);
                } else {
                    console.log('No previous detection results found');
                }
            } catch (error) {
                console.error('Error loading detection results:', error);
            }
        }

        // Update evil twins display
        function updateEvilTwinsDisplay(evilTwins) {
            const container = document.getElementById('evilTwinsContainer');
            
            if (!evilTwins || evilTwins.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <div>No evil twin networks detected. This is good!</div>
                    </div>
                `;
                return;
            }

            let html = '';
            evilTwins.forEach(twin => {
                html += `
                    <div class="evil-twin-details">
                        <h4 style="color: #ff4444; margin-bottom: 10px;">
                            <i class="fas fa-exclamation-triangle"></i>
                            CRITICAL: Evil Twin Detected
                        </h4>
                        <p><strong>SSID:</strong> ${twin.ssid}</p>
                        <p><strong>Risk Score:</strong> <span class="threat-badge threat-badge-critical">${twin.risk_score}/10</span></p>
                        <p><strong>Likely Rogue:</strong> ${twin.likely_rogue || 'Unknown'}</p>
                        <p><strong>Legitimate:</strong> ${twin.likely_legitimate || 'Unknown'}</p>
                        
                        <div class="risk-factors">
                            <strong>Risk Factors:</strong>
                            ${twin.risk_factors.map(factor => `<div class="risk-factor"><i class="fas fa-exclamation"></i>${factor}</div>`).join('')}
                        </div>
                        
                        <small style="color: #8892b0;">Detected: ${formatTimestamp(twin.detection_timestamp)}</small>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update rogue APs display
        function updateRogueApsDisplay(rogueAps) {
            const container = document.getElementById('rogueApsContainer');
            
            if (!rogueAps || rogueAps.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <div>No rogue access points detected.</div>
                    </div>
                `;
                return;
            }

            let html = '';
            rogueAps.forEach(rogue => {
                const riskLevel = rogue.risk_score > 7 ? 'critical' : rogue.risk_score > 5 ? 'high' : 'medium';
                html += `
                    <div class="rogue-details">
                        <h4 style="color: #f85149; margin-bottom: 10px;">
                            <i class="fas fa-wifi"></i>
                            Rogue AP: ${rogue.ssid || '(Hidden)'}
                        </h4>
                        <p><strong>BSSID:</strong> ${rogue.bssid}</p>
                        <p><strong>Vendor:</strong> ${rogue.vendor}</p>
                        <p><strong>Risk Score:</strong> <span class="threat-badge threat-badge-${riskLevel}">${rogue.risk_score}/10</span></p>
                        
                        <div class="risk-factors">
                            <strong>Risk Factors:</strong>
                            ${rogue.risk_factors.map(factor => `<div class="risk-factor"><i class="fas fa-exclamation"></i>${factor}</div>`).join('')}
                        </div>
                        
                        <small style="color: #8892b0;">Detected: ${formatTimestamp(rogue.detection_timestamp)}</small>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update suspicious display
        function updateSuspiciousDisplay(suspicious) {
            const container = document.getElementById('suspiciousContainer');
            
            if (!suspicious || suspicious.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <div>No suspicious network activity detected.</div>
                    </div>
                `;
                return;
            }

            let html = '';
            suspicious.forEach(sus => {
                html += `
                    <div class="suspicious-details">
                        <h4 style="color: #fb8500; margin-bottom: 10px;">
                            <i class="fas fa-question-circle"></i>
                            Suspicious: ${sus.ssid}
                        </h4>
                        <p><strong>BSSID:</strong> ${sus.bssid}</p>
                        <p><strong>Risk Score:</strong> <span class="threat-badge threat-badge-medium">${sus.risk_score}/10</span></p>
                        
                        <div class="risk-factors">
                            <strong>Suspicion Factors:</strong>
                            ${sus.suspicion_factors.map(factor => `<div class="risk-factor"><i class="fas fa-info"></i>${factor}</div>`).join('')}
                        </div>
                        
                        <small style="color: #8892b0;">Detected: ${formatTimestamp(sus.detection_timestamp)}</small>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update recommendations display
        function updateRecommendationsDisplay(recommendations) {
            const container = document.getElementById('recommendationsContainer');
            
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = `
                    <div class="recommendations">
                        <h4 style="color: #533ee8; margin-bottom: 15px;">
                            <i class="fas fa-lightbulb"></i>
                            Security Recommendations
                        </h4>
                        <div class="recommendation-item">
                            <i class="fas fa-check-circle"></i>
                            <div>No specific threats detected. Continue regular monitoring for optimal security.</div>
                        </div>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="recommendations">
                    <h4 style="color: #533ee8; margin-bottom: 15px;">
                        <i class="fas fa-lightbulb"></i>
                        Security Recommendations
                    </h4>
            `;

            recommendations.forEach(rec => {
                html += `
                    <div class="recommendation-item">
                        <i class="fas fa-arrow-right"></i>
                        <div>${rec}</div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.closest('.tab').classList.add('active');
        }

        // Export results
        async function exportResults() {
            try {
                showNotification('Preparing export...', 'info');

                const exportData = {
                    timestamp: new Date().toISOString(),
                    detection_results: detectionResults,
                    summary: {
                        evil_twins: detectionResults.evil_twins ? detectionResults.evil_twins.length : 0,
                        rogue_aps: detectionResults.rogue_aps ? detectionResults.rogue_aps.length : 0,
                        suspicious: detectionResults.suspicious ? detectionResults.suspicious.length : 0,
                        threat_level: document.getElementById('threatLevel').textContent
                    }
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `rogue_ap_detection_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                showNotification('Results exported successfully', 'success');
                
            } catch (error) {
                console.error('Error exporting results:', error);
                showNotification('Failed to export results: ' + error.message, 'error');
            }
        }

        // Clear results
        function clearResults() {
            if (confirm('Are you sure you want to clear all detection results?')) {
                detectionResults = {
                    evil_twins: [],
                    rogue_aps: [],
                    suspicious: [],
                    recommendations: []
                };
                
                // Reset statistics
                document.getElementById('evilTwinsCount').textContent = '0';
                document.getElementById('rogueApsCount').textContent = '0';
                document.getElementById('suspiciousCount').textContent = '0';
                document.getElementById('legitimateCount').textContent = '0';
                document.getElementById('openNetworksCount').textContent = '0';
                document.getElementById('weakSecurityCount').textContent = '0';

                // Reset threat level
                updateThreatLevel('LOW');

                // Clear displays
                loadInitialData();
                
                // Clear chart
                if (threatChart) {
                    threatChart.data.datasets[0].data = [0, 0, 0, 0];
                    threatChart.update();
                }

                showNotification('Results cleared', 'info');
            }
        }

        // Load initial data
        function loadInitialData() {
            updateEvilTwinsDisplay([]);
            updateRogueApsDisplay([]);
            updateSuspiciousDisplay([]);
            updateRecommendationsDisplay([]);
        }

        // Check detection status
        async function checkDetectionStatus() {
            try {
                const response = await fetch('/passive-monitor/api/rogue-detection-status', {
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    detecting = data.is_detecting;
                    updateDetectionUI();
                    updateRealtimeStats(data);

                    if (detecting) {
                        startRealTimeUpdates();
                    } else {
                        // Load any existing results
                        loadDetectionResults();
                    }
                }
            } catch (error) {
                console.error('Error checking detection status:', error);
            }
        }

        // Utility functions
        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${getNotificationColor(type)};
                color: white;
                border-radius: 8px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
                border: 1px solid ${getNotificationBorderColor(type)};
                max-width: 300px;
                word-wrap: break-word;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function getNotificationColor(type) {
            switch (type) {
                case 'success': return 'rgba(46, 160, 67, 0.9)';
                case 'error': return 'rgba(248, 81, 73, 0.9)';
                case 'warning': return 'rgba(251, 133, 0, 0.9)';
                default: return 'rgba(83, 62, 232, 0.9)';
            }
        }

        function getNotificationBorderColor(type) {
            switch (type) {
                case 'success': return '#2ea043';
                case 'error': return '#f85149';
                case 'warning': return '#fb8500';
                default: return '#533ee8';
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopRealTimeUpdates();
            stopProgressTracking();
        });

        console.log('Rogue AP Detection page initialized successfully');
    </script>
</body>
</html>